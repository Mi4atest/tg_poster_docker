# Система резервного копирования базы данных

Эта документация описывает систему автоматического резервного копирования базы данных с отправкой архивов в Telegram.

## Обзор системы

Система резервного копирования включает в себя:

1. **Ежедневное автоматическое резервное копирование** базы данных
2. **Отправку резервных копий в Telegram** для удобного доступа и хранения
3. **Ротацию старых резервных копий** для экономии места
4. **Инструменты для восстановления** из резервных копий

## Компоненты системы

### Скрипты

- `backup.sh` - основной скрипт для создания резервных копий
- `restore.sh` - скрипт для восстановления из резервных копий
- `setup_backup.sh` - скрипт для настройки автоматического резервного копирования

### Директории

- `backups/` - директория для хранения резервных копий и логов

### Переменные окружения

В файле `.env` должны быть указаны:
- `BACKUP_BOT_TOKEN` - токен Telegram-бота для отправки резервных копий
- `BACKUP_CHAT_ID` - ID чата для отправки резервных копий

## Настройка системы

### Первоначальная настройка

1. Запустите скрипт настройки:
   ```bash
   ./setup_backup.sh
   ```

2. Следуйте инструкциям скрипта:
   - Введите токен Telegram-бота (получите его у @BotFather)
   - Введите ID чата для отправки резервных копий (получите его у @userinfobot)
   - Выберите время для ежедневного резервного копирования

3. Скрипт автоматически:
   - Добавит необходимые переменные в файл `.env`
   - Настроит задание cron для автоматического резервного копирования
   - Предложит выполнить тестовое резервное копирование

### Создание Telegram-бота для резервных копий

1. Откройте Telegram и найдите @BotFather
2. Отправьте команду `/newbot`
3. Следуйте инструкциям для создания бота
4. Получите токен бота и используйте его в настройках
5. Начните чат с вашим ботом и отправьте ему любое сообщение
6. Используйте @userinfobot, чтобы узнать ваш CHAT_ID

## Использование системы

### Ручное создание резервной копии

```bash
./backup.sh
```

Скрипт:
1. Создаст резервную копию базы данных
2. Сожмет её в формат .gz
3. Отправит в указанный Telegram-чат
4. Удалит старые резервные копии согласно политике ротации

### Восстановление из резервной копии

```bash
./restore.sh путь/к/файлу/резервной_копии.sql.gz
```

Скрипт:
1. Проверит существование файла
2. Распакует его, если он сжат
3. Запросит подтверждение перед восстановлением
4. Восстановит базу данных из резервной копии

## Политика ротации резервных копий

Система автоматически управляет хранением резервных копий:

1. Удаляет файлы старше 30 дней
2. Если общий размер резервных копий превышает 1GB, удаляет самые старые файлы

## Мониторинг и логирование

Все действия системы резервного копирования логируются в файл `backups/backup.log`.

Для просмотра логов:
```bash
cat backups/backup.log
```

## Устранение неполадок

### Проблема: Резервная копия не создается

1. Проверьте логи:
   ```bash
   cat backups/backup.log
   ```

2. Убедитесь, что переменные окружения правильно настроены:
   ```bash
   grep BACKUP_ .env
   ```

3. Проверьте, что скрипт имеет права на выполнение:
   ```bash
   chmod +x backup.sh
   ```

### Проблема: Резервная копия не отправляется в Telegram

1. Проверьте подключение к интернету
2. Убедитесь, что токен бота и ID чата указаны правильно
3. Проверьте, что бот активен и имеет права на отправку файлов

### Проблема: Ошибка при восстановлении

1. Убедитесь, что файл резервной копии не поврежден
2. Проверьте, что база данных существует и доступна
3. Убедитесь, что у пользователя postgres есть необходимые права

## Дополнительные рекомендации

1. Регулярно проверяйте, что резервные копии создаются успешно
2. Периодически тестируйте процесс восстановления
3. Храните резервные копии не только в Telegram, но и в других местах
4. Настройте уведомления о статусе резервного копирования
