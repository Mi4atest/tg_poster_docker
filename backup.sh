#!/bin/bash

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏
BACKUP_DIR="$(dirname "$0")/backups"
TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
BACKUP_FILE="tg_poster_backup_$TIMESTAMP.sql"
COMPRESSED_FILE="$BACKUP_FILE.gz"
LOG_FILE="$BACKUP_DIR/backup.log"

# –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–∑ .env —Ñ–∞–π–ª–∞
if [ -f "$(dirname "$0")/.env" ]; then
    source "$(dirname "$0")/.env"
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è Telegram
if [ -z "$BACKUP_BOT_TOKEN" ] || [ -z "$BACKUP_CHAT_ID" ]; then
    echo "–û—à–∏–±–∫–∞: –ù–µ –∑–∞–¥–∞–Ω—ã –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è BACKUP_BOT_TOKEN –∏/–∏–ª–∏ BACKUP_CHAT_ID"
    echo "–î–æ–±–∞–≤—å—Ç–µ –∏—Ö –≤ —Ñ–∞–π–ª .env –∏–ª–∏ –∑–∞–¥–∞–π—Ç–µ –≤—Ä—É—á–Ω—É—é –≤ —Å–∫—Ä–∏–ø—Ç–µ"
    exit 1
fi

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
log() {
    echo "[$(date +"%Y-%m-%d %H:%M:%S")] $1" | tee -a "$LOG_FILE"
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ Telegram
send_message() {
    curl -s -X POST "https://api.telegram.org/bot$BACKUP_BOT_TOKEN/sendMessage" \
         -d "chat_id=$BACKUP_CHAT_ID" \
         -d "text=$1" \
         -d "parse_mode=HTML"
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–∞–π–ª–æ–≤ –≤ Telegram
send_file() {
    curl -s -F document=@"$1" \
         -F caption="$2" \
         "https://api.telegram.org/bot$BACKUP_BOT_TOKEN/sendDocument?chat_id=$BACKUP_CHAT_ID"
}

# –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –±—ç–∫–∞–ø–æ–≤, –µ—Å–ª–∏ –æ–Ω–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
mkdir -p "$BACKUP_DIR"
touch "$LOG_FILE"

# –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–∞—á–∞–ª–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
log "–ù–∞—á–∞–ª–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è"
send_message "üîÑ <b>–ù–∞—á–∞—Ç–æ —Ä–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö</b>"

# –°–æ–∑–¥–∞–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
log "–°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
docker-compose -f "$(dirname "$0")/docker-compose.yml" exec -T db pg_dump -U postgres tg_poster > "$BACKUP_DIR/$BACKUP_FILE"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —É—Å–ø–µ—à–Ω–æ –ª–∏ —Å–æ–∑–¥–∞–Ω —Ñ–∞–π–ª
if [ ! -s "$BACKUP_DIR/$BACKUP_FILE" ]; then
    log "–û—à–∏–±–∫–∞: –§–∞–π–ª —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ –ø—É—Å—Ç –∏–ª–∏ –Ω–µ —Å–æ–∑–¥–∞–Ω"
    send_message "‚ùå <b>–û—à–∏–±–∫–∞: –§–∞–π–ª —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ –Ω–µ —Å–æ–∑–¥–∞–Ω!</b>"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞
if [ $(stat -c%s "$BACKUP_DIR/$BACKUP_FILE") -lt 1000 ]; then
    log "–û—à–∏–±–∫–∞: –§–∞–π–ª —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ —Å–ª–∏—à–∫–æ–º –º–∞–ª ($(stat -c%s "$BACKUP_DIR/$BACKUP_FILE") –±–∞–π—Ç)"
    send_message "‚ùå <b>–û—à–∏–±–∫–∞: –§–∞–π–ª —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ —Å–ª–∏—à–∫–æ–º –º–∞–ª!</b>"
    exit 1
fi

# –°–∂–∏–º–∞–µ–º —Ñ–∞–π–ª
log "–°–∂–∞—Ç–∏–µ —Ñ–∞–π–ª–∞ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏..."
gzip -f "$BACKUP_DIR/$BACKUP_FILE"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —É—Å–ø–µ—à–Ω–æ –ª–∏ —Å–∂–∞—Ç —Ñ–∞–π–ª
if [ ! -f "$BACKUP_DIR/$COMPRESSED_FILE" ]; then
    log "–û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å —Å–∂–∞—Ç—å —Ñ–∞–π–ª —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏"
    send_message "‚ùå <b>–û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å —Å–∂–∞—Ç—å —Ñ–∞–π–ª —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏!</b>"
    exit 1
fi

# –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–∞–π–ª –≤ Telegram
log "–û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–∞–π–ª–∞ –≤ Telegram..."
FILESIZE=$(du -h "$BACKUP_DIR/$COMPRESSED_FILE" | cut -f1)
send_file "$BACKUP_DIR/$COMPRESSED_FILE" "–†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö tg_poster –æ—Ç $(date +"%d.%m.%Y %H:%M"). –†–∞–∑–º–µ—Ä: $FILESIZE"

# –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏ (–æ—Å—Ç–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7)
log "–£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π..."
find "$BACKUP_DIR" -name "tg_poster_backup_*.gz" -type f -mtime +30 -delete
log "–£–¥–∞–ª–µ–Ω—ã —Ñ–∞–π–ª—ã —Å—Ç–∞—Ä—à–µ 30 –¥–Ω–µ–π"

# –ï—Å–ª–∏ –æ–±—â–∏–π —Ä–∞–∑–º–µ—Ä –±—ç–∫–∞–ø–æ–≤ –ø—Ä–µ–≤—ã—à–∞–µ—Ç 1GB, —É–¥–∞–ª—è–µ–º —Å–∞–º—ã–µ —Å—Ç–∞—Ä—ã–µ
while [ $(du -sm "$BACKUP_DIR" | cut -f1) -gt 1000 ]; do
    oldest_file=$(ls -tr "$BACKUP_DIR"/tg_poster_backup_*.gz 2>/dev/null | head -n 1)
    if [ -z "$oldest_file" ]; then
        break
    fi
    rm -f "$oldest_file"
    log "–£–¥–∞–ª–µ–Ω —Å—Ç–∞—Ä—ã–π —Ñ–∞–π–ª: $oldest_file"
done

# –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
log "–†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!"
send_message "‚úÖ <b>–†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!</b>
üìÅ –ò–º—è —Ñ–∞–π–ª–∞: $COMPRESSED_FILE
üìä –†–∞–∑–º–µ—Ä: $FILESIZE
üïí –î–∞—Ç–∞: $(date +"%d.%m.%Y %H:%M")"

exit 0
