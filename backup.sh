#!/bin/bash

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏
BACKUP_DIR="$(dirname "$0")/backups"
TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
LOG_FILE="$BACKUP_DIR/backup.log"

# –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–∑ .env —Ñ–∞–π–ª–∞
if [ -f "$(dirname "$0")/.env" ]; then
    source "$(dirname "$0")/.env"
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è Telegram
if [ -z "$BACKUP_BOT_TOKEN" ] || [ -z "$BACKUP_CHAT_ID" ]; then
    echo "–û—à–∏–±–∫–∞: –ù–µ –∑–∞–¥–∞–Ω—ã –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è BACKUP_BOT_TOKEN –∏/–∏–ª–∏ BACKUP_CHAT_ID"
    echo "–î–æ–±–∞–≤—å—Ç–µ –∏—Ö –≤ —Ñ–∞–π–ª .env –∏–ª–∏ –∑–∞–¥–∞–π—Ç–µ –≤—Ä—É—á–Ω—É—é –≤ —Å–∫—Ä–∏–ø—Ç–µ"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∏–º–µ–Ω–∏ –ø—Ä–æ–µ–∫—Ç–∞
if [ -z "$BACKUP_PROJECT_NAME" ]; then
    BACKUP_PROJECT_NAME="tg_poster"
    echo "–ò–º—è –ø—Ä–æ–µ–∫—Ç–∞ –Ω–µ –∑–∞–¥–∞–Ω–æ, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: $BACKUP_PROJECT_NAME"
fi

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–º—è —Ñ–∞–π–ª–∞ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –∏–º–µ–Ω–∏ –ø—Ä–æ–µ–∫—Ç–∞
BACKUP_FILE="${BACKUP_PROJECT_NAME}_backup_$TIMESTAMP.sql"
COMPRESSED_FILE="$BACKUP_FILE.gz"

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
log() {
    echo "[$(date +"%Y-%m-%d %H:%M:%S")] $1" | tee -a "$LOG_FILE"
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–∞–π–ª–æ–≤ –≤ Telegram —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–º –æ–ø–∏—Å–∞–Ω–∏–µ–º
send_file() {
    local file="$1"
    local server_name=$(hostname)
    local server_ip=$(hostname -I | awk '{print $1}')
    
    local caption="üì¶ <b>–†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö</b>
üîπ <b>–ü—Ä–æ–µ–∫—Ç:</b> ${BACKUP_PROJECT_NAME}
üîπ <b>–°–µ—Ä–≤–µ—Ä:</b> ${server_name} (${server_ip})
üîπ <b>–î–∞—Ç–∞:</b> $(date +"%d.%m.%Y %H:%M")
üîπ <b>–†–∞–∑–º–µ—Ä:</b> $(du -h "$file" | cut -f1)"

    curl -s -F document=@"$file" \
         -F caption="$caption" \
         -F parse_mode="HTML" \
         "https://api.telegram.org/bot$BACKUP_BOT_TOKEN/sendDocument?chat_id=$BACKUP_CHAT_ID"
}

# –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –±—ç–∫–∞–ø–æ–≤, –µ—Å–ª–∏ –æ–Ω–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
mkdir -p "$BACKUP_DIR"
touch "$LOG_FILE"

# –ù–∞—á–∏–Ω–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
log "–ù–∞—á–∞–ª–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è"

# –°–æ–∑–¥–∞–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
log "–°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
docker-compose -f "$(dirname "$0")/docker-compose.yml" exec -T db pg_dump -U postgres tg_poster > "$BACKUP_DIR/$BACKUP_FILE"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —É—Å–ø–µ—à–Ω–æ –ª–∏ —Å–æ–∑–¥–∞–Ω —Ñ–∞–π–ª
if [ ! -s "$BACKUP_DIR/$BACKUP_FILE" ]; then
    log "–û—à–∏–±–∫–∞: –§–∞–π–ª —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ –ø—É—Å—Ç –∏–ª–∏ –Ω–µ —Å–æ–∑–¥–∞–Ω"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞
if [ $(stat -c%s "$BACKUP_DIR/$BACKUP_FILE") -lt 1000 ]; then
    log "–û—à–∏–±–∫–∞: –§–∞–π–ª —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ —Å–ª–∏—à–∫–æ–º –º–∞–ª ($(stat -c%s "$BACKUP_DIR/$BACKUP_FILE") –±–∞–π—Ç)"
    exit 1
fi

# –°–∂–∏–º–∞–µ–º —Ñ–∞–π–ª
log "–°–∂–∞—Ç–∏–µ —Ñ–∞–π–ª–∞ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏..."
gzip -f "$BACKUP_DIR/$BACKUP_FILE"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —É—Å–ø–µ—à–Ω–æ –ª–∏ —Å–∂–∞—Ç —Ñ–∞–π–ª
if [ ! -f "$BACKUP_DIR/$COMPRESSED_FILE" ]; then
    log "–û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å —Å–∂–∞—Ç—å —Ñ–∞–π–ª —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏"
    exit 1
fi

# –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–∞–π–ª –≤ Telegram
log "–û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–∞–π–ª–∞ –≤ Telegram..."
send_file "$BACKUP_DIR/$COMPRESSED_FILE"

# –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ–¥–∏–∞-—Ñ–∞–π–ª–æ–≤ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
if [ "$BACKUP_MEDIA" = "true" ]; then
    log "–°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ –º–µ–¥–∏–∞-—Ñ–∞–π–ª–æ–≤..."
    MEDIA_BACKUP_FILE="${BACKUP_PROJECT_NAME}_media_$TIMESTAMP.tar.gz"
    
    # –°–æ–∑–¥–∞–µ–º –∞—Ä—Ö–∏–≤ –º–µ–¥–∏–∞-—Ñ–∞–π–ª–æ–≤
    tar -czf "$BACKUP_DIR/$MEDIA_BACKUP_FILE" -C "$(dirname "$0")" media
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —É—Å–ø–µ—à–Ω–æ –ª–∏ —Å–æ–∑–¥–∞–Ω —Ñ–∞–π–ª
    if [ ! -f "$BACKUP_DIR/$MEDIA_BACKUP_FILE" ]; then
        log "–û—à–∏–±–∫–∞: –§–∞–π–ª —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ –º–µ–¥–∏–∞ –Ω–µ —Å–æ–∑–¥–∞–Ω"
    else
        log "–†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è –º–µ–¥–∏–∞-—Ñ–∞–π–ª–æ–≤ —Å–æ–∑–¥–∞–Ω–∞: $MEDIA_BACKUP_FILE"
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–∞–π–ª –≤ Telegram (–µ—Å–ª–∏ –æ–Ω –Ω–µ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π)
        if [ $(stat -c%s "$BACKUP_DIR/$MEDIA_BACKUP_FILE") -lt 50000000 ]; then
            log "–û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–∞–π–ª–∞ –º–µ–¥–∏–∞-—Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ –≤ Telegram..."
            send_file "$BACKUP_DIR/$MEDIA_BACKUP_FILE"
        else
            log "–§–∞–π–ª –º–µ–¥–∏–∞-—Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram"
        fi
    fi
fi

# –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏ (–æ—Å—Ç–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7)
log "–£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π..."
find "$BACKUP_DIR" -name "${BACKUP_PROJECT_NAME}_backup_*.gz" -type f -mtime +30 -delete
log "–£–¥–∞–ª–µ–Ω—ã —Ñ–∞–π–ª—ã —Å—Ç–∞—Ä—à–µ 30 –¥–Ω–µ–π"

# –ï—Å–ª–∏ –æ–±—â–∏–π —Ä–∞–∑–º–µ—Ä –±—ç–∫–∞–ø–æ–≤ –ø—Ä–µ–≤—ã—à–∞–µ—Ç 1GB, —É–¥–∞–ª—è–µ–º —Å–∞–º—ã–µ —Å—Ç–∞—Ä—ã–µ
while [ $(du -sm "$BACKUP_DIR" | cut -f1) -gt 1000 ]; do
    oldest_file=$(ls -tr "$BACKUP_DIR"/${BACKUP_PROJECT_NAME}_backup_*.gz 2>/dev/null | head -n 1)
    if [ -z "$oldest_file" ]; then
        break
    fi
    rm -f "$oldest_file"
    log "–£–¥–∞–ª–µ–Ω —Å—Ç–∞—Ä—ã–π —Ñ–∞–π–ª: $oldest_file"
done

log "–†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!"
exit 0
